================================================================================
MOD-04 STORAGE & DOKUMENTEN-SSOT ‚Äî VOLLST√ÑNDIGE IST/SOLL ANALYSE
================================================================================
Erstellt: 2026-02-02
Status: IST-Analyse abgeschlossen + SOLL-Entscheidungen

================================================================================
A) IST-STAND STORAGE / DMS / WORKERS
================================================================================

--------------------------------------------------------------------------------
A1) SUPABASE STORAGE
--------------------------------------------------------------------------------

‚úÖ BUCKET EXISTIERT:
   - Name: "tenant-documents"
   - √ñffentlich: NEIN (privat)
   - RLS: Ja (storage policies aktiv)

‚úÖ KEY-KONVENTION (aktuell in useSmartUpload.ts):
   Format: {tenant_id}/raw/{YYYY}/{MM}/{document_id}-{filename}
   
   Beispiele:
   - tenant-documents/abc123/raw/2026/02/docid-expose.pdf
   - tenant-documents/abc123/derived/{document_id}/metadata.json

‚úÖ UPLOAD-CODE EXISTIERT:
   Dateien:
   - src/hooks/useSmartUpload.ts ‚Äî Hauptupload-Hook
   - src/components/shared/FileUploader.tsx ‚Äî Drag&Drop UI-Komponente
   - supabase/functions/sot-dms-upload-url/index.ts ‚Äî Signed URL Generator
   - supabase/functions/sot-dms-download-url/index.ts ‚Äî Download URL Generator

‚úÖ DOWNLOAD/SIGNED-URL:
   - sot-dms-download-url Edge Function erstellt signedUrls (max 1h)
   - Pr√ºft Tenant-Zugeh√∂rigkeit via profiles.active_tenant_id

--------------------------------------------------------------------------------
A2) DATENMODELL DOKUMENTE
--------------------------------------------------------------------------------

‚úÖ TABELLE: documents
   Spalten:
   - id (UUID, PK)
   - tenant_id (UUID, FK ‚Üí organizations)
   - public_id (text, z.B. "SOT-D-ABCD1234")
   - name (text) ‚Äî Dateiname
   - file_path (text) ‚Äî Storage-Key
   - mime_type (text)
   - size_bytes (integer)
   - doc_type (text) ‚Äî Dokumenttyp-Code
   - scope (text) ‚Äî PROPERTY/UNIT/FINANCE/CONTACT
   - source (text) ‚Äî upload/resend/caya/dropbox/...
   - extraction_status (text) ‚Äî pending/processing/done/failed
   - extracted_json_path (text) ‚Äî Pfad zu Sidecar-JSON
   - sidecar_json (jsonb) ‚Äî Inline-Metadaten
   - ai_summary (text)
   - detected_type (text)
   - match_confidence (numeric)
   - review_state (text)
   - uploaded_by (UUID, FK ‚Üí auth.users)
   - created_at, updated_at

‚úÖ TABELLE: document_links
   Spalten:
   - id (UUID, PK)
   - tenant_id (UUID)
   - document_id (UUID, FK ‚Üí documents)
   - node_id (UUID, FK ‚Üí storage_nodes) ‚Äî optional Ordner-Verkn√ºpfung
   - object_id (UUID) ‚Äî polymorph: property_id / unit_id / lease_id / loan_id
   - object_type (text) ‚Äî "property" | "unit" | "lease" | "loan" | "contact"
   - unit_id (UUID, FK ‚Üí units) ‚Äî redundant f√ºr schnellen Zugriff
   - link_status (text) ‚Äî pending/accepted/rejected
   - created_at, updated_at

‚úÖ TABELLE: storage_nodes (virtuelles Ordnersystem)
   Spalten:
   - id (UUID, PK)
   - tenant_id (UUID)
   - parent_id (UUID, FK ‚Üí storage_nodes) ‚Äî Hierarchie
   - name (text)
   - node_type (text) ‚Äî "folder" | "file"
   - property_id (UUID, FK ‚Üí properties) ‚Äî Kontext
   - unit_id (UUID, FK ‚Üí units) ‚Äî Kontext
   - template_id (text) ‚Äî z.B. "PROPERTY_DOSSIER_V1"
   - doc_type_hint (text) ‚Äî erwarteter doc_type
   - scope_hint (text) ‚Äî PROPERTY/UNIT
   - sort_index (integer)
   - auto_created (boolean) ‚Äî System-Ordner
   - created_at, updated_at

‚úÖ TABELLE: doc_type_catalog (Referenztabelle)
   Spalten:
   - doc_type (text, PK) ‚Äî z.B. "DOC_LEASE_CONTRACT"
   - scope_default (text) ‚Äî PROPERTY/UNIT
   - required_meta (text[]) ‚Äî Pflicht-Felder
   - anchors (jsonb) ‚Äî Matching-Regeln f√ºr AI
   - extractable_dp_keys (text[]) ‚Äî Extrahierbare Datenpunkte
   - posting_suggestion_rules (jsonb) ‚Äî Buchungsvorschl√§ge
   - created_at

‚úÖ TABELLE: extractions (AI-Analyse-Log)
   Spalten:
   - id, tenant_id, document_id
   - engine (text) ‚Äî lovable_ai/unstructured_fast/unstructured_hires
   - source (text)
   - status (text) ‚Äî pending/processing/done/failed
   - result_json (jsonb) ‚Äî Extrahierte Daten
   - actual_pages, actual_cost_cents
   - consent_given_at, consent_given_by
   - started_at, finished_at
   - error_message

‚úÖ ZUORDNUNG DOKUMENTE:
   √úber document_links mit object_id + object_type (polymorph)
   Unterst√ºtzt: property, unit, lease, loan, contact

--------------------------------------------------------------------------------
A3) WORKER / JOB QUEUE
--------------------------------------------------------------------------------

‚ùå KEINE DEDIZIERTE JOB-QUEUE TABELLE

   Aktueller Mechanismus:
   - Edge Functions werden synchron aufgerufen
   - sot-document-parser ‚Üí Lovable AI (synchron)
   - Keine pg-boss, bullmq, Camunda vorhanden
   
   Vorgesehenes Pattern (Memory Hints):
   - Extraction-Jobs √ºber extractions-Tabelle trackbar
   - Status: pending ‚Üí processing ‚Üí done/failed
   - Kein separater Worker-Prozess, sondern Event-driven via Edge Functions

   Edge Functions f√ºr DMS:
   - sot-document-parser ‚Äî AI-Parsing via Lovable AI (Gemini 3 Flash)
   - sot-dms-upload-url ‚Äî Signed Upload URLs
   - sot-dms-download-url ‚Äî Signed Download URLs

--------------------------------------------------------------------------------
A4) RLS / PERMISSIONS
--------------------------------------------------------------------------------

‚úÖ TENANT-SCHL√úSSEL: tenant_id (UUID)
   - Alle Tabellen haben tenant_id als FK ‚Üí organizations
   - RLS-Policies filtern nach tenant_id

‚úÖ ORG-HIERARCHIE EXISTIERT:
   Tabelle: organizations
   - id, parent_id (selbstreferenzierend)
   - org_type (enum: platform_operator, client, partner, subpartner)
   - depth (integer) ‚Äî Hierarchieebene
   - materialized_path (text) ‚Äî z.B. "/abc/def/"
   - parent_access_blocked (boolean)
   
   Hilfsfunktion: my_scope_org_ids(active_org_id) ‚Üí UUID[]
   - Gibt alle sichtbaren Org-IDs zur√ºck (Kinder + delegierte)

‚ö†Ô∏è LINTER-WARNUNGEN:
   - 2x Security Definer View (pr√ºfen)
   - 2x RLS Policy mit "true" (√ºberm√§√üig permissiv)
   - Extension in public schema
   - Leaked password protection disabled


================================================================================
B) SOLL-TAXONOMIE ‚Äî ORDNERSTRUKTUR (18 ORDNER)
================================================================================

--------------------------------------------------------------------------------
B1) ENTSCHEIDUNG: HYBRID-MODELL (Empfohlen)
--------------------------------------------------------------------------------

Empfehlung: (c) HYBRID

Begr√ºndung:
- storage_nodes in DB f√ºr virtuelle Ordner (Hierarchie, Metadaten, Scopes)
- Storage-Key im Bucket bleibt flach: {tenant_id}/raw/{YYYY}/{MM}/{doc_id}-{name}
- Vorteile:
  ‚Ä¢ Ordnerstruktur jederzeit √§nderbar ohne Storage-Migration
  ‚Ä¢ Suche/Filter √ºber DB statt Storage-Listing
  ‚Ä¢ doc_type_hint auf Ordnerebene f√ºr Auto-Zuordnung
  ‚Ä¢ Mehrere Dokumente pro Ordner einfach

Bereits implementiert in DB-Trigger:
- create_property_folder_structure() ‚Üí Erstellt Template-Ordner bei Property-Insert
- create_unit_folder() ‚Üí Erstellt Unit-Unterordner bei Multi-Unit

--------------------------------------------------------------------------------
B2) DOC_TYPE MAPPING (18 Ordner ‚Üí doc_type ‚Üí Extraktions-Template)
--------------------------------------------------------------------------------

CODE  | ORDNER-NAME                        | DOC_TYPE             | SCOPE   | EXTRAKTION
------|-------------------------------------|----------------------|---------|------------------
00    | Projektdokumentation               | DOC_PROJECT          | PROPERTY| Nein
01    | Expos√© Ankauf                      | DOC_EXPOSE_BUY       | PROPERTY| Ja (Kaufpreis, qm)
02    | Expos√© Sonstiges                   | DOC_EXPOSE_MISC      | PROPERTY| Nein
03    | Grundbuchauszug                    | DOC_LAND_REGISTER    | PROPERTY| Ja (Grundbuch-Daten)
04    | Teilungserkl√§rung                  | DOC_DIVISION_DECL    | PROPERTY| Ja (MEA, TE-Nr)
05    | Grundriss                          | DOC_FLOORPLAN        | UNIT    | Ja (qm, Zimmer)
06    | Kurzgutachten                      | DOC_VALUATION_SHORT  | PROPERTY| Ja (Verkehrswert)
07    | Kaufvertrag                        | DOC_PURCHASE_CONTRACT| PROPERTY| Ja (Kaufpreis, Datum)
08    | Mietvertrag                        | DOC_LEASE_CONTRACT   | UNIT    | Ja (Miete, Mieter, Start)
09    | Rechnungen                         | DOC_INVOICE          | UNIT    | Ja (Betrag, Datum)
10    | Wirtschaftsplan/Protokolle         | DOC_WEG_BUCKET       | PROPERTY| Ja (Hausgeld)
11    | Fotos                              | DOC_PHOTOS           | UNIT    | Nein
12    | Energieausweis                     | DOC_ENERGY_CERT      | PROPERTY| Ja (Wert, G√ºltig bis)
13    | Wohngeb√§udeversicherung            | DOC_INSURANCE_BUILD  | PROPERTY| Ja (Beitrag, Ablauf)
14    | Sonstiges                          | DOC_MISC             | UNIT    | Nein
15    | Darlehen und Finanzierung          | DOC_LOAN_BUCKET      | PROPERTY| Ja (Bank, Zins, Rate)
16    | Sanierung                          | DOC_RENOVATION       | UNIT    | Ja (Kosten, Jahr)
17    | Grundsteuer                        | DOC_PROPERTY_TAX     | PROPERTY| Ja (Bescheid, Betrag)

Zus√§tzlich f√ºr √úbergabe:
18    | √úbergabeprotokoll                  | DOC_HANDOVER         | UNIT    | Ja (Z√§hlerst√§nde)

--------------------------------------------------------------------------------
B3) VERSIONIERUNG ‚Äî MEHRERE DOKUMENTE PRO DOC_TYPE
--------------------------------------------------------------------------------

Entscheidung: MEHRERE DATEIEN ERLAUBT + NEWEST FLAG

Schema-Erweiterung:
```sql
ALTER TABLE document_links ADD COLUMN is_current BOOLEAN DEFAULT true;
ALTER TABLE document_links ADD COLUMN replaced_by UUID REFERENCES document_links(id);
ALTER TABLE document_links ADD COLUMN version_note TEXT;
```

Logik:
- Upload eines neuen Dokuments mit gleichem doc_type + object_id:
  ‚Ä¢ Altes document_link bekommt is_current = false
  ‚Ä¢ Neues bekommt is_current = true
  ‚Ä¢ Optional: replaced_by auf neues Dokument setzen
- UI zeigt standardm√§√üig nur is_current = true
- Historien-Button f√ºr Versionen


================================================================================
C) UX: DRAG&DROP IN DER IMMOBILIENAKTE
================================================================================

--------------------------------------------------------------------------------
C1) DROPZONE-PLATZIERUNG
--------------------------------------------------------------------------------

SEKTION                          | DROPZONE | AKZEPTIERTE DOC_TYPES
---------------------------------|----------|----------------------------------------
Block D: Grundbuch & Erwerb      | ‚úÖ       | DOC_LAND_REGISTER, DOC_DIVISION_DECL,
                                 |          | DOC_PURCHASE_CONTRACT
Block E: Investment/KPIs         | ‚ùå       | (nur derived)
Block F: Mietverh√§ltnis          | ‚úÖ       | DOC_LEASE_CONTRACT, DOC_HANDOVER
Block G: WEG & Hausgeld          | ‚úÖ       | DOC_WEG_BUCKET
Block H: Finanzierung            | ‚úÖ       | DOC_LOAN_BUCKET
Block I: Accounting/AfA          | ‚úÖ       | DOC_PROPERTY_TAX
Block J: Dokumente (Checklist)   | ‚úÖ       | ALLE (Fallback)

Rechte Sidebar:
- Vollst√§ndige Dokument-Checkliste mit Status pro doc_type
- Globale Dropzone als Fallback

--------------------------------------------------------------------------------
C2) AUTO-ZUORDNUNG DOC_TYPE
--------------------------------------------------------------------------------

1. Dropzone in Sektion X ‚Üí doc_type aus Mapping (z.B. Block H ‚Üí DOC_LOAN_BUCKET)
2. Mehrere erlaubte doc_types ‚Üí AI-Erkennung w√§hlt besten Match
3. User kann doc_type via Dropdown √ºberschreiben
4. Mehrfach-Uploads: Alle bekommen gleichen doc_type der Sektion

Workflow:
```
Upload in Block H (Finanzierung)
  ‚Üí Erstelle document mit doc_type = null
  ‚Üí Rufe sot-document-parser
  ‚Üí AI erkennt: "Darlehensvertrag" ‚Üí doc_type = DOC_LOAN_BUCKET (confidence 0.9)
  ‚Üí Falls confidence < 0.8: Zeige Vorschlag, User best√§tigt
  ‚Üí Erstelle document_link mit object_id = property_id, object_type = "property"
```

--------------------------------------------------------------------------------
C3) STATUS & REVIEW
--------------------------------------------------------------------------------

Status-Flow:
```
uploaded ‚Üí processing ‚Üí [needs_review | accepted | failed]
```

Status in document_links.link_status:
- pending: Upload abgeschlossen, Extraktion l√§uft
- needs_review: AI-Confidence < 0.8 oder Konflikte
- accepted: Automatisch akzeptiert (Confidence ‚â• 0.8)
- rejected: User hat abgelehnt

Anzeige:
- Checklist (Block J): Status-Icon pro doc_type
  ‚Ä¢ ‚ö™ Fehlend
  ‚Ä¢ üü° Pending/Processing
  ‚Ä¢ üü† Needs Review
  ‚Ä¢ üü¢ Akzeptiert
  ‚Ä¢ üî¥ Fehlgeschlagen

- Block-Dropzone: Badge mit Anzahl + Status


================================================================================
D) EXTRAKTION / FELD√úBERNAHME
================================================================================

--------------------------------------------------------------------------------
D1) TRIGGER
--------------------------------------------------------------------------------

Trigger: Nach document INSERT mit extraction_status = 'pending'

Flow:
1. useSmartUpload erstellt document-Record
2. Ruft sot-document-parser Edge Function
3. Edge Function:
   - Nutzt Lovable AI (Gemini 3 Flash)
   - Gibt ParseResult zur√ºck
4. Update document mit extraction_status = done + sidecar_json
5. Erstelle extractions-Record f√ºr Audit

Korrelation:
- document.tenant_id + document_links.object_id ‚Üí Property/Unit/Lease/Loan

--------------------------------------------------------------------------------
D2) OUTPUT ‚Äî SOLL-ENTSCHEIDUNG
--------------------------------------------------------------------------------

Empfehlung: OPTION 1 ‚Äî Zwischenspeicher + Approval

Schema:
```sql
CREATE TABLE extraction_suggestions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES organizations(id),
  extraction_id UUID REFERENCES extractions(id),
  document_id UUID REFERENCES documents(id),
  target_table TEXT NOT NULL, -- 'properties' | 'units' | 'leases' | 'loans'
  target_id UUID NOT NULL,
  field_name TEXT NOT NULL,
  suggested_value JSONB,
  confidence NUMERIC(3,2),
  status TEXT DEFAULT 'pending', -- pending | approved | rejected
  approved_by UUID,
  approved_at TIMESTAMPTZ,
  current_value JSONB, -- Vergleichswert
  created_at TIMESTAMPTZ DEFAULT now()
);
```

Workflow:
1. AI extrahiert Felder ‚Üí Speichern in extraction_suggestions
2. UI zeigt Vorschl√§ge in der Akte (Inline oder Sidebar)
3. User klickt "√úbernehmen" oder "Ablehnen"
4. Bei √úbernahme: Patch auf Ziel-Tabelle + status = approved
5. Manuelle Eingabe √ºberschreibt IMMER

--------------------------------------------------------------------------------
D3) APPROVAL UX
--------------------------------------------------------------------------------

Anzeige in Akte:
- Feld mit AI-Vorschlag bekommt gelben Rand + ‚ú®-Icon
- Tooltip: "AI-Vorschlag: {Wert} (Konfidenz: 85%)"
- Buttons: [√úbernehmen] [Ablehnen] [Bearbeiten]

Vorschlagsliste:
- Block J (Dokumente) hat "AI-Vorschl√§ge" Sektion
- Gruppiert nach Dokument
- Batch-√úbernahme m√∂glich

Audit:
- extraction_suggestions.approved_by/at f√ºr Nachvollziehbarkeit
- Keine separate audit_log-Tabelle n√∂tig (Minimal-Ansatz)


================================================================================
E) VERLINKUNG IN LISTEN & DOWNSTREAM-MODULE
================================================================================

--------------------------------------------------------------------------------
E1) PORTFOLIO-LISTE MOD-04
--------------------------------------------------------------------------------

Spalten (Reihenfolge):
| # | FELD              | QUELLE           | ANMERKUNG                    |
|---|-------------------|------------------|------------------------------|
| 1 | Code              | properties.code  | Oder public_id               |
| 2 | Art               | properties.property_type | Enum-Label          |
| 3 | Ort               | properties.city  |                              |
| 4 | Stra√üe/Nr.        | properties.address + house_number |             |
| 5 | Gr√∂√üe (qm)        | units.area_sqm   | Summe bei Globalobjekt       |
| 6 | Nutzung           | properties.usage_type |                         |
| 7 | Einnahmen p.a.    | SUM(leases.rent_cold_eur * 12) | Derived       |
| 8 | Verkehrswert      | properties.market_value |                       |
| 9 | Restschuld        | SUM(loans.outstanding_balance) |                |
|10 | Rate              | SUM(loans.annuity_monthly) |                     |
|11 | Warmmiete         | leases.rent_cold_eur + nk_advance_eur |          |
|12 | NK-Vorauszahlung  | leases.nk_advance_eur |                          |
|13 | Hausgeld          | units.hausgeld_monthly |                         |

Aggregation Globalobjekt:
- Zeige Property-Zeile + expandierbare Unit-Zeilen
- Summen f√ºr: Einnahmen, Restschuld, Rate

--------------------------------------------------------------------------------
E2) MSV (MOD-05)
--------------------------------------------------------------------------------

Filter:
- properties.rental_managed = true ODER
- msv_enrollments.status = 'active'

Expos√©-Ansicht:
- Zeigt: Adresse, qm, Warmmiete, Mieter, Kontakt
- READ-ONLY Derivat aus MOD-04

Dokumente:
- Zeigt nur: DOC_LEASE_CONTRACT, DOC_HANDOVER
- Filter: document_links.object_type = 'unit' AND link_status = 'accepted'

--------------------------------------------------------------------------------
E3) VERKAUF (MOD-06)
--------------------------------------------------------------------------------

Filter:
- properties.sale_enabled = true ODER
- listings.status IN ('draft', 'active', 'reserved')

Expos√©-Daten:
- Basis: properties + units (qm, Zimmer, Ausstattung)
- Erweiterung: listings-Tabelle (Preis, Beschreibung, Fotos)

Datenraum:
- Gespiegelte Dokumente √ºber access_grants-Tabelle
- doc_types im Verkaufs-Datenraum:
  ‚Ä¢ DOC_LAND_REGISTER, DOC_DIVISION_DECL
  ‚Ä¢ DOC_FLOORPLAN, DOC_ENERGY_CERT
  ‚Ä¢ DOC_EXPOSE_BUY (Ankauf)
  ‚Ä¢ DOC_PHOTOS

--------------------------------------------------------------------------------
E4) FINANZIERUNG (MOD-07)
--------------------------------------------------------------------------------

Objektauswahl:
- Aus MOD-04 Portfolio (Filter: alle aktiven Properties)
- Felder √ºbernommen: Adresse, qm, Kaufpreis, Verkehrswert

Dokument-Checklist (finance_documents-Mapping):
| DOC_TYPE             | ERFORDERLICH | KATEGORIE      |
|----------------------|--------------|----------------|
| DOC_PURCHASE_CONTRACT| ‚úÖ           | Objekt         |
| DOC_LAND_REGISTER    | ‚úÖ           | Objekt         |
| DOC_FLOORPLAN        | ‚ö™           | Objekt         |
| DOC_ENERGY_CERT      | ‚ö™           | Objekt         |
| DOC_EXPOSE_BUY       | ‚ö™           | Objekt         |

Keine doppelte Dokumenthaltung:
- finance_documents verweist auf documents.id
- Nur Links, keine Kopien
- access_grants f√ºr Freigabe an Finanzierungsmanager


================================================================================
F) ZONE-1 / TILE CATALOG / SPEC-GIT / MANIFEST
================================================================================

--------------------------------------------------------------------------------
F1) ROUTES-MANIFEST STATUS
--------------------------------------------------------------------------------

‚úÖ MOD-04 ROUTES KORREKT:
   Datei: src/manifests/routesManifest.ts

   ```typescript
   "MOD-04": {
     name: "Immobilien",
     base: "immobilien",
     tiles: [
       { path: "kontexte", component: "KontexteTab" },
       { path: "portfolio", component: "PortfolioTab" },
       { path: "sanierung", component: "SanierungTab" },
       { path: "bewertung", component: "BewertungTab" },
     ],
     dynamic_routes: [
       { path: ":id", component: "PropertyDetail" },
       ...
     ]
   }
   ```

‚ö†Ô∏è PR√úFEN: PropertyDetail.tsx
   - Default-Tab sollte "Akte" sein (SSOT)
   - Aktuell implementiert: EditableUnitDossierView als Akte-Tab

--------------------------------------------------------------------------------
F2) TILE CATALOG OVERLAY
--------------------------------------------------------------------------------

Datei: manifests/tile_catalog.yaml

MOD-04 Eintrag korrekt:
```yaml
MOD-04:
  code: "MOD-04"
  title: "Immobilien"
  main_route: "/portal/immobilien"
  sub_tiles:
    - title: "Kontexte"
    - title: "Portfolio"
    - title: "Sanierung"
    - title: "Bewertung"
```

‚ö†Ô∏è FEHLEND: Kein "Akte"-Tab im Tile Catalog
   Grund: Akte ist Detail-Ansicht (PropertyDetail), nicht Sub-Tile

--------------------------------------------------------------------------------
F3) SPEC-DATEIEN AKTUALISIERUNG
--------------------------------------------------------------------------------

Dateien die aktualisiert werden m√ºssen:

1. docs/modules/MOD-04_IMMOBILIEN.md
   - Erg√§nzen: Vollst√§ndiger SSOT-Feldkatalog (Block A-J)
   - Erg√§nzen: Dokument-Taxonomie (18 doc_types)
   - Erg√§nzen: Dropzone-Konzept

2. docs/architecture/ADR-038_Storage_Architecture.md
   - Erg√§nzen: Hybrid-Modell Entscheidung
   - Erg√§nzen: storage_nodes Template-Struktur
   - Erg√§nzen: doc_type_catalog Schema

3. spec/current/06_api_contracts/module_api_overview.md
   - Erg√§nzen: sot-dms-upload-url API
   - Erg√§nzen: sot-dms-download-url API
   - Erg√§nzen: Extraction Suggestions API (neu)

4. NEUES DOKUMENT: docs/modules/MOD-04_FIELD_MAPPING.md
   - Vollst√§ndiges Feld ‚Üí DB-Spalte Mapping
   - Validation Rules
   - Extraction Templates


================================================================================
G) NOTWENDIGE REPO-√ÑNDERUNGEN (PRIORISIERT)
================================================================================

--------------------------------------------------------------------------------
P0 (SOFORT)
--------------------------------------------------------------------------------

1. DB MIGRATION: extraction_suggestions Tabelle
   ```sql
   CREATE TABLE extraction_suggestions (...);
   CREATE INDEX idx_es_doc ON extraction_suggestions(document_id);
   CREATE INDEX idx_es_target ON extraction_suggestions(target_table, target_id);
   ```

2. DB MIGRATION: document_links Erweiterung
   ```sql
   ALTER TABLE document_links ADD COLUMN is_current BOOLEAN DEFAULT true;
   ALTER TABLE document_links ADD COLUMN version_note TEXT;
   ```

3. DOC_TYPE_CATALOG SEED:
   - 18 doc_types aus Mapping B2

4. UI: BlockDropzone-Komponente
   - Generische Dropzone pro Block
   - Props: acceptedDocTypes[], objectId, objectType

5. UI: DocumentChecklist mit Status
   - Zeigt alle 18 Ordner mit Status
   - Verlinkt zu Dokumenten

--------------------------------------------------------------------------------
P1 (N√ÑCHSTE ITERATION)
--------------------------------------------------------------------------------

6. HOOK: useExtractionSuggestions
   - L√§dt Vorschl√§ge f√ºr Entity
   - Approve/Reject Mutations

7. UI: AI-Vorschl√§ge Inline-Anzeige
   - Gelber Rand bei Feldern mit Vorschlag
   - Tooltip mit Konfidenz

8. EDGE FUNCTION: sot-extraction-approve
   - Batch-√úbernahme von Vorschl√§gen
   - Audit-Trail

9. SPEC-DOKUMENTE aktualisieren

--------------------------------------------------------------------------------
P2 (SP√ÑTER)
--------------------------------------------------------------------------------

10. Chart of Accounts (SKR04) Seed
11. Accounting-Block UI vollst√§ndig
12. NK-Perioden-Verwaltung UI


================================================================================
ZUSAMMENFASSUNG
================================================================================

IST:
- Storage-Infrastruktur vorhanden (Bucket, Upload-Hooks, Edge Functions)
- Datenmodell f√ºr Dokumente robust (documents, document_links, storage_nodes)
- doc_type_catalog existiert, aber leer
- Keine Extraction-Suggestions-Tabelle

SOLL:
- Hybrid-Modell: virtuelle Ordner in DB, flache Storage-Keys
- 18 doc_types mit Scope und Extraktions-Templates
- Dropzones pro Akte-Block
- AI-Feld√ºbernahme mit Approval-Workflow
- Downstream-Module (MSV/Verkauf/Finanzierung) lesen nur aus MOD-04

N√ÑCHSTE SCHRITTE:
1. extraction_suggestions Tabelle anlegen
2. doc_type_catalog seeden
3. BlockDropzone-Komponente implementieren
4. DocumentChecklist mit Status bauen

================================================================================
ENDE BERICHT
================================================================================
