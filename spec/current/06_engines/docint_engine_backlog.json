{
  "engine": "ENG-DOCINT",
  "name": "Document Intelligence Engine",
  "version": "3.0",
  "updated_at": "2026-02-25",
  "owner": "Zone 1",
  "credit_model": {
    "unit": "1 Credit = 0.25 EUR = 25 Cent",
    "services": [
      { "service": "Posteingang PDF-Extraktion", "unit": "pro PDF", "credits": 1, "eur": 0.25, "phase": "1" },
      { "service": "Storage-Extraktion", "unit": "pro Dokument", "credits": 1, "eur": 0.25, "phase": "1" },
      { "service": "NK-Beleg-Parsing", "unit": "pro Beleg", "credits": 1, "eur": 0.25, "phase": "1" },
      { "service": "Cloud-Sync Import", "unit": "pro Datei", "credits": 1, "eur": 0.25, "phase": "2" },
      { "service": "FinAPI Konto-Sync", "unit": "pro Konto", "credits": 4, "eur": 1.00, "phase": "2" },
      { "service": "Auto-Matching (Doc→Vertrag)", "unit": "pro Match", "credits": 2, "eur": 0.50, "phase": "2" }
    ]
  },
  "architecture": {
    "central_parser": "supabase/functions/sot-document-parser/index.ts",
    "shared_module": "supabase/functions/_shared/tabular-parser.ts",
    "upload_hook": "src/hooks/useUniversalUpload.ts",
    "storage_manifest": "src/config/storageManifest.ts",
    "parser_manifest": "src/config/parserManifest.ts",
    "removed": ["supabase/functions/sot-pdf-to-csv/ (konsolidiert in sot-document-parser v3)"],
    "pipeline": {
      "path_a_direct": "XLSX/CSV → SheetJS (deterministisch, kein AI) → columnMapping + rows",
      "path_b_ai": "PDF/Bild → Gemini Flash Vision → strukturierte Extraktion (Tool-Calling)",
      "path_b_csv_preprocessing": "PDF mit Tabellen → Gemini Flash → CSV → SheetJS → columnMapping + rows",
      "upload_sanitization": "sanitizeFileName() aus storageManifest.ts (systemweit, alle 7 Stellen)"
    }
  },
  "phases": [
    {
      "phase": "1",
      "label": "Phase 1 — Live",
      "items": [
        {
          "id": "P1.1",
          "feature": "Resend Inbound Webhook",
          "status": "live",
          "component": "supabase/functions/sot-inbound-receive/",
          "description": "Empfängt E-Mails via Resend Webhook, extrahiert PDF-Anhänge, speichert in tenant-documents Storage."
        },
        {
          "id": "P1.2",
          "feature": "Universal Document Parser v3",
          "status": "live",
          "component": "supabase/functions/sot-document-parser/ + _shared/tabular-parser.ts",
          "description": "Universeller Parser: XLSX/CSV direkt via SheetJS (Path A), PDF/Bilder via Gemini Flash Vision (Path B). 10+ spezialisierte Modi via parserManifest. Erweitertes Response-Schema mit extractionMethod, columnMapping, tabularMeta."
        },
        {
          "id": "P1.3",
          "feature": "document_chunks + TSVector Volltextsuche",
          "status": "live",
          "component": "search_document_chunks() RPC",
          "description": "Extrahierter Text wird in Chunks gespeichert und via PostgreSQL TSVector durchsuchbar gemacht."
        },
        {
          "id": "P1.4",
          "feature": "Auto-Sortierung (Rules Engine)",
          "status": "live",
          "component": "inbox_sort_containers + inbox_sort_rules",
          "description": "Keyword-basierte Sortierung von Posteingangs-Dokumenten in Entity-Ordner."
        },
        {
          "id": "P1.5",
          "feature": "Credit-Preflight System",
          "status": "live",
          "component": "tenant_credit_balance + rpc_credit_preflight/deduct/topup",
          "description": "Saldo-Tabelle mit Preflight-Check, Debit-Buchung und Top-Up. 100 Gratis-Credits bei Erstregistrierung."
        },
        {
          "id": "P1.6",
          "feature": "Auto-Trigger (Inbound → Parser → Chunks)",
          "status": "live",
          "component": "supabase/functions/sot-inbound-receive/ → sot-document-parser",
          "description": "Automatische Pipeline: PDF-Upload → Gemini-Extraktion → document_chunks. Credit-Preflight vor Extraktion."
        },
        {
          "id": "P1.7",
          "feature": "Shared Tabular Parser (XLSX/CSV/PDF→CSV)",
          "status": "live",
          "component": "supabase/functions/_shared/tabular-parser.ts",
          "description": "Zentrales Modul für tabellarische Datenextraktion: SheetJS für XLSX/CSV (deterministisch), Gemini Flash für PDF→CSV-Preprocessing. Fuzzy Column-Mapping mit STANDARD_COLUMN_PATTERNS. Genutzt von sot-document-parser und sot-project-intake."
        },
        {
          "id": "P1.8",
          "feature": "Upload-Sanitization (systemweit)",
          "status": "live",
          "component": "src/config/storageManifest.ts → sanitizeFileName()",
          "description": "Alle 7 Upload-Stellen im System nutzen sanitizeFileName() für Sonderzeichen/Umlaute/Leerzeichen. UPLOAD_BUCKET als zentrale Konstante. Eliminiert 'Invalid key'-Fehler systemweit."
        }
      ]
    },
    {
      "phase": "2",
      "label": "Phase 2 — Implementiert",
      "items": [
        {
          "id": "P2.1",
          "feature": "Storage-Extraktion (eigene Dateien)",
          "status": "live",
          "priority": "P1",
          "description": "User klickt 'Dokument auslesen' im DMS → Signed URL → Gemini Vision → document_chunks. 1 Credit/Dokument.",
          "component": "supabase/functions/sot-storage-extract/ + PreviewView.tsx"
        },
        {
          "id": "P2.2",
          "feature": "NK-Beleg-Parsing",
          "status": "live",
          "priority": "P1",
          "description": "Spezieller parseMode 'nk_beleg' extrahiert Versorger, Betrag, Zeitraum, Kostenkategorie. Ergebnis in nk_beleg_extractions. 1 Credit/Beleg.",
          "component": "supabase/functions/sot-nk-beleg-parse/ + nk_beleg_extractions Tabelle"
        },
        {
          "id": "P2.3",
          "feature": "Cloud-Sync (Google Drive)",
          "status": "scaffold",
          "priority": "P2",
          "description": "OAuth2-Flow → Dateien kopieren in Tenant-Storage → automatische Extraktion. 1 Credit/Datei.",
          "component": "supabase/functions/sot-cloud-sync/ + cloud_sync_connectors + cloud_sync_log",
          "requires": ["GOOGLE_DRIVE_CLIENT_ID", "GOOGLE_DRIVE_CLIENT_SECRET"]
        },
        {
          "id": "P2.6",
          "feature": "RAG-Index (pgvector Embedding)",
          "status": "live",
          "priority": "P3",
          "description": "pgvector Extension aktiv → Embedding-Spalte (768d) auf document_chunks → hybrid_search_documents RPC → Semantische + TSVector Suche.",
          "component": "supabase/functions/sot-embedding-pipeline/ + hybrid_search_documents RPC + document_chunks.embedding"
        }
      ]
    }
  ],
  "removed_components": [
    {
      "component": "sot-pdf-to-csv",
      "removed_at": "2026-02-25",
      "reason": "Logik konsolidiert in sot-document-parser v3 via _shared/tabular-parser.ts. Die eigenständige Edge Function wurde nie von anderen Funktionen aufgerufen und duplizierte CSV-Extraction-Prompt + uint8ToBase64."
    }
  ],
  "dependencies": {
    "phase_1": [
      { "dep": "Lovable AI (Gemini Vision)", "status": "live" },
      { "dep": "Supabase Storage (tenant-documents)", "status": "live" },
      { "dep": "document_chunks + TSVector", "status": "live" },
      { "dep": "tenant_credit_balance + RPCs", "status": "live" },
      { "dep": "inbox_sort_rules", "status": "live" },
      { "dep": "SheetJS (xlsx@0.18.5 via esm.sh)", "status": "live" }
    ],
    "phase_2": [
      { "dep": "pgvector Extension", "status": "live" },
      { "dep": "nk_beleg_extractions Tabelle", "status": "live" },
      { "dep": "cloud_sync_connectors + cloud_sync_log", "status": "live" },
      { "dep": "OAuth2 Token Management", "status": "scaffold" },
      { "dep": "Stripe (Credit Top-Up)", "status": "planned" }
    ]
  }
}
