{
  "engine": "ENG-DOCINT",
  "name": "Document Intelligence Engine",
  "version": "2.0",
  "updated_at": "2026-02-18",
  "owner": "Zone 1",
  "credit_model": {
    "unit": "1 Credit = 0.25 EUR = 25 Cent",
    "services": [
      { "service": "Posteingang PDF-Extraktion", "unit": "pro PDF", "credits": 1, "eur": 0.25, "phase": "1" },
      { "service": "Storage-Extraktion", "unit": "pro Dokument", "credits": 1, "eur": 0.25, "phase": "2" },
      { "service": "NK-Beleg-Parsing", "unit": "pro Beleg", "credits": 1, "eur": 0.25, "phase": "2" },
      { "service": "Cloud-Sync Import", "unit": "pro Datei", "credits": 1, "eur": 0.25, "phase": "2" },
      { "service": "FinAPI Konto-Sync", "unit": "pro Konto", "credits": 4, "eur": 1.00, "phase": "2" },
      { "service": "Auto-Matching (Doc→Vertrag)", "unit": "pro Match", "credits": 2, "eur": 0.50, "phase": "2" }
    ]
  },
  "phases": [
    {
      "phase": "1",
      "label": "Phase 1 — Live",
      "items": [
        {
          "id": "P1.1",
          "feature": "Resend Inbound Webhook",
          "status": "live",
          "component": "supabase/functions/sot-inbound-receive/",
          "description": "Empfängt E-Mails via Resend Webhook, extrahiert PDF-Anhänge, speichert in tenant-documents Storage."
        },
        {
          "id": "P1.2",
          "feature": "Gemini Vision Parser",
          "status": "live",
          "component": "supabase/functions/sot-document-parser/",
          "description": "KI-basierte Dokumentenanalyse via Lovable AI Gateway (Gemini 3 Flash). Erkennt Immobilien, Kontakte, Finanzierungen."
        },
        {
          "id": "P1.3",
          "feature": "document_chunks + TSVector Volltextsuche",
          "status": "live",
          "component": "search_document_chunks() RPC",
          "description": "Extrahierter Text wird in Chunks gespeichert und via PostgreSQL TSVector durchsuchbar gemacht."
        },
        {
          "id": "P1.4",
          "feature": "Auto-Sortierung (Rules Engine)",
          "status": "live",
          "component": "inbox_sort_containers + inbox_sort_rules",
          "description": "Keyword-basierte Sortierung von Posteingangs-Dokumenten in Entity-Ordner."
        },
        {
          "id": "P1.5",
          "feature": "Credit-Preflight System",
          "status": "live",
          "component": "tenant_credit_balance + rpc_credit_preflight/deduct/topup",
          "description": "Saldo-Tabelle mit Preflight-Check, Debit-Buchung und Top-Up. 100 Gratis-Credits bei Erstregistrierung."
        },
        {
          "id": "P1.6",
          "feature": "Auto-Trigger (Inbound → Parser → Chunks)",
          "status": "live",
          "component": "supabase/functions/sot-inbound-receive/ → sot-document-parser",
          "description": "Automatische Pipeline: PDF-Upload → Gemini-Extraktion → document_chunks. Credit-Preflight vor Extraktion."
        }
      ]
    },
    {
      "phase": "2",
      "label": "Phase 2 — Implementiert",
      "items": [
        {
          "id": "P2.1",
          "feature": "Storage-Extraktion (eigene Dateien)",
          "status": "live",
          "priority": "P1",
          "description": "User klickt 'Dokument auslesen' im DMS → Signed URL → Gemini Vision → document_chunks. 1 Credit/Dokument.",
          "component": "supabase/functions/sot-storage-extract/ + PreviewView.tsx"
        },
        {
          "id": "P2.2",
          "feature": "NK-Beleg-Parsing",
          "status": "live",
          "priority": "P1",
          "description": "Spezieller parseMode 'nk_beleg' extrahiert Versorger, Betrag, Zeitraum, Kostenkategorie. Ergebnis in nk_beleg_extractions. 1 Credit/Beleg.",
          "component": "supabase/functions/sot-nk-beleg-parse/ + nk_beleg_extractions Tabelle"
        },
        {
          "id": "P2.3",
          "feature": "Cloud-Sync (Google Drive)",
          "status": "scaffold",
          "priority": "P2",
          "description": "OAuth2-Flow → Dateien kopieren in Tenant-Storage → automatische Extraktion. 1 Credit/Datei. Edge Function + DB-Tabellen bereit.",
          "component": "supabase/functions/sot-cloud-sync/ + cloud_sync_connectors + cloud_sync_log",
          "requires": ["GOOGLE_DRIVE_CLIENT_ID", "GOOGLE_DRIVE_CLIENT_SECRET"]
        },
        {
          "id": "P2.4",
          "feature": "Cloud-Sync (Dropbox/OneDrive)",
          "status": "scaffold",
          "priority": "P3",
          "description": "Wie GDrive, zusätzliche Provider. Nutzt gleiche Edge Function + DB-Tabellen.",
          "component": "supabase/functions/sot-cloud-sync/",
          "requires": ["DROPBOX_CLIENT_ID", "DROPBOX_CLIENT_SECRET", "ONEDRIVE_CLIENT_ID", "ONEDRIVE_CLIENT_SECRET"]
        },
        {
          "id": "P2.5",
          "feature": "FinAPI Konto-Matching",
          "status": "scaffold",
          "priority": "P2",
          "description": "PSD2 Bank-Connect → Transaktionen importieren → Auto-Matching zu Verträgen. 4 Credits/Konto, 2 Credits/Match-Batch.",
          "component": "supabase/functions/sot-finapi-sync/ + finapi_connections + finapi_transactions",
          "requires": ["FINAPI_CLIENT_ID", "FINAPI_CLIENT_SECRET", "§34f GewO Lizenz"]
        },
        {
          "id": "P2.6",
          "feature": "RAG-Index (pgvector Embedding)",
          "status": "live",
          "priority": "P3",
          "description": "pgvector Extension aktiv → Embedding-Spalte (768d) auf document_chunks → hybrid_search_documents RPC → Semantische + TSVector Suche.",
          "component": "supabase/functions/sot-embedding-pipeline/ + hybrid_search_documents RPC + document_chunks.embedding"
        }
      ]
    }
  ],
  "dependencies": {
    "phase_1": [
      { "dep": "Lovable AI (Gemini Vision)", "status": "live" },
      { "dep": "Supabase Storage (tenant-documents)", "status": "live" },
      { "dep": "document_chunks + TSVector", "status": "live" },
      { "dep": "tenant_credit_balance + RPCs", "status": "live" },
      { "dep": "inbox_sort_rules", "status": "live" }
    ],
    "phase_2": [
      { "dep": "pgvector Extension", "status": "live" },
      { "dep": "nk_beleg_extractions Tabelle", "status": "live" },
      { "dep": "cloud_sync_connectors + cloud_sync_log", "status": "live" },
      { "dep": "finapi_connections + finapi_transactions", "status": "live" },
      { "dep": "hybrid_search_documents RPC", "status": "live" },
      { "dep": "OAuth2 Token Management", "status": "scaffold (benötigt Client-Credentials)" },
      { "dep": "FinAPI SDK", "status": "scaffold (benötigt API-Key + §34f)" },
      { "dep": "Stripe (Credit Top-Up)", "status": "planned" }
    ]
  }
}
